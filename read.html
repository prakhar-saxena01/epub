<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href="lib/bootstrap/v3/css/bootstrap.min.css" rel="stylesheet" media="screen">
	<link href="lib/bootstrap/v3/css/bootstrap-theme.min.css" rel="stylesheet" media="screen">
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<script src="lib/bootstrap/v3/js/jquery.js"></script>
	<script src="lib/bootstrap/v3/js/bootstrap.min.js"></script>

	<script src="lib/promise.js"></script>
	<script src="lib/fetch.js"></script>

	<script src="lib/zip.min.js"></script>
	<script src="lib/localforage.min.js"></script>
	<script src="lib/epub.js"></script>
	<script src="lib/smartimages.js"></script>
	<script src="js/read.js"></script>
	<script src="js/common.js"></script>

	<link id="favicon" rel="shortcut icon" type="image/png" href="img/favicon.png" />
	<link type="text/css" rel="stylesheet" media="screen" href="css/read.css" />

	<link type="text/css" rel="stylesheet" media="screen" href="themes/default.css" id="theme_css" />
</head>
<body>

<div class="modal fade" id="settings-modal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Settings</h4>
      </div>
      <div class="modal-body">
			<form name="settings-form" onsubmit="return false" class="form-horizontal">

				<div class="form-group">
					<label class="col-sm-3 control-label">Font</label>
					<div class="col-sm-9">
						<select class="font_family form-control" onchange="apply_font(this)">
							<option>Arial</option>
						 	<option>Times New Roman</option>
							<option>Georgia</option>
							<option>Courier New</option>
						</select>
					</div>
  				</div>

				<div class="form-group">
					<label class="col-sm-3 control-label">Text size</label>
					<div class="col-sm-9">
						<select class="font_size form-control" onchange="apply_font_size(this)"></select>
					</div>
  				</div>

				<div class="form-group">
					<label class="col-sm-3 control-label">Line height</label>
					<div class="col-sm-9">
						<select class="line_height form-control" onchange="apply_line_height(this)"></select>
					</div>
  				</div>

				<div class="form-group">
					<label class="col-sm-3 control-label">Theme</label>
					<div class="col-sm-9">
						<select class="theme_name form-control" onchange="change_theme(this)">
							<option value="default">Default</option>
							<option value="mocca">Mocca</option>
						 	<option value="night">Night</option>
						 	<option value="plan9">Plan9</option>
						</select>
					</div>
  				</div>

				<div class="form-group">
					<label class="col-sm-3 control-label"></label>
					<div class="col-sm-9">
						<div class="text-muted">Options take effect after reload:</div>

						<div class="checkbox">
							<label>
								<input class="transition_checkbox"
									type="checkbox"> Disable transitions
							</label>
						</div>
						<div class="checkbox">
							<label>
								<input class="fullscreen_checkbox"
									type="checkbox"> Request fullscreen mode
							</label>
						</div>
					</div>
  				</div>

				<hr/>

				<div class="form-group">
					<label class="col-sm-3 control-label">Last location</label>
					<div class="col-sm-9">

						<div class="input-group">
							<input type="numeric" disabled="disabled" class="form-control lastread_input">
							<span class="input-group-btn">
								<button class="btn btn-danger" type="button" onclick="clear_lastread()">Clear</button>
							</span>
						</div>
					</div>
  				</div>

				<div class="form-group">
					<label class="col-sm-3 control-label"></label>
					<div class="col-sm-9">
						<button class="btn btn-primary" type="button" onclick="mark_as_read()">Mark as read</button>
					</div>
  				</div>

			</form>
      </div>
      <div class="modal-footer">
             <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="dict-modal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Dictionary Lookup</h4>
      </div>
		<input type="hidden" class="dict_query" value=""/>
      <div class="modal-body">
			<div class="dict_result"> </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="dict_search_btn btn-default btn">Google</button>
        <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="toc-modal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Table of Contents</h4>
      </div>
      <div class="modal-body">
			<ul class="toc_list list-unstyled"> </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="search-modal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Search</h4>
      </div>
      <div class="modal-body">

			<form class="form-horizontal" onsubmit="return false;">
				<div class="form-group">
					<label class="col-sm-4 control-label">Search (active chapter)</label>
					<div class="col-sm-8">
						<input type="search" class="form-control search_input">
					</div>
  				</div>

				<ol class="search_results"> </ol>

			</form>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" onclick="search()">Search</button>
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="container">
<div class="header">
	<span>
		<a href="#" onclick="save_and_close()">&laquo;&nbsp;Exit</a>
		<span class="title"></span>
	</span>
	<span class="toolbar">

		<!-- <button class="btn btn-default btn-xs"
			data-toggle="modal" data-target="#toc-modal">
			<span class="glyphicon glyphicon-th-list" aria-hidden="true"></span>
		</button> -->

		<button class="btn btn-default btn-xs"
			data-toggle="modal" data-target="#settings-modal">
			<span class="glyphicon glyphicon-wrench" aria-hidden="true"></span>
		</button>

		<button class="btn btn-default btn-xs"
			data-toggle="modal" data-target="#search-modal">
			<span class="glyphicon glyphicon-search" aria-hidden="true"></span>
		</button>

		<!-- <button class="btn btn-default btn-xs hidden-xs" onclick="zoom(2)">
			<span class="glyphicon glyphicon-zoom-in" aria-hidden="true"></span>
		</button>

		<button class="btn btn-default btn-xs hidden-xs" onclick="zoom(-2)">
			<span class="glyphicon glyphicon-zoom-out" aria-hidden="true"></span>
		</button> -->

	</span>
</div>

<div class="footer">
	<div class="chapter" data-toggle="modal" data-target="#toc-modal"></div>
	<div class="location">
		<span id="cur_page">?</span> / <span id="total_pages">?</span>
		(<span id="page_pct">?</span>)
	</div>
</div>

<div id="reader"></div>

<div class="loading">
	<div class="loading_message">
		Opening book...
	</div>
</div>
</div>

<script type='text/javascript'>
	'use strict';

	var _pagination_stored = 0;
	var _last_position_sync = 0;

	var _is_ios = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
	var _res_data = [];

	const DEFAULT_FONT_SIZE = 16;
	const DEFAULT_FONT_FAMILY = "Georgia";
	const DEFAULT_LINE_HEIGHT = 140;

	function cacheId(suffix) {
		return "epube-book." + $.urlParam("b") + (suffix ? "." + suffix : "");
	}

	$(document).ready(function() {
		if ('serviceWorker' in navigator) {
 			 navigator.serviceWorker
           .register('worker.js')
           .then(function() {
					console.log("service worker registered");

					init_loader();
				});
		}
	});

	function init_loader() {
		// we need to preload resources for reader iframe because it can't utilize our
		// service worker because while offline it is created outside our base server context
		var res_names = [ "lib/bootstrap/v3/js/jquery.js", "lib/jquery.mobile.custom.js",
			"css/transitions.css",
			"js/reader.js", "css/reader.css", "js/dict.js",
			"themes/default.css", "themes/mocca.css", "themes/night.css", "themes/plan9.css" ];

		for (var i = 0; i < res_names.length; i++) {
			fetch(res_names[i], {credentials: 'same-origin'}).then(function(resp) {
				if (resp.status == 200) resp.text().then(function(data) {
					_res_data[resp.url] = data;
				});
			});
		}

		check_resource_load(res_names, _res_data, 0);
	}

	function check_resource_load(res_names, res_data, attempt) {
		console.log("check_resource_load", attempt, res_names.length, Object.keys(res_data).length);

		if (attempt == 5) {
			$(".loading_message").html("Unable to load resources.");
			return;
		}

		if (res_names.length != Object.keys(res_data).length) {
			window.setTimeout(function() {
				check_resource_load(res_names, res_data, attempt+1);
			}, 250);
		} else {
			init_reader();
		}
	}

	function init_reader() {
		apply_theme();

		$(window).on('online', function() {
			console.log("we're online, storing lastread");

			var currentPage = book.pagination.pageFromCfi(book.getCurrentLocationCfi());
			var currentCfi = book.getCurrentLocationCfi();

			$.post("backend.php", { op: "storelastread", id: $.urlParam("id"), page: currentPage,
				cfi: currentCfi }, function(data) {

					if (data.cfi) {
						_last_position_sync = new Date().getTime()/1000;
					}
				});
		});

		localforage.getItem(cacheId("book")).then(function(item) {

			// ios doesn't work with FileReader for whatever reason
			if (/*!_is_ios &&*/ item) {

				console.log("loading from local storage");

				var fileReader = new FileReader();

				fileReader.onload = function(evt) {
					try {
						book.open(this.result);
					} catch (e) {
						$(".loading_message").html("Unable to load book (local).");
						console.log(e);
					}
				};

				fileReader.readAsArrayBuffer(item);

			} else {

				console.log("loading from network");

				if (navigator.onLine) {
					var book_url = "backend.php?op=download&id=" + $.urlParam("id");

					RSVP.on('error', function(error) {
						if ($(".loading").is(":visible")) {
							$(".loading_message").html("Unable to load book (remote).");
						}
						console.log(error);
					});

					fetch(book_url, {credentials: 'same-origin'}).then(function(resp) {

						if (resp.status == 200) {
							var bookId = $.urlParam("b");

							// let's store this for later
							localforage.setItem(cacheId('book'), resp.clone().blob());

							// if there's no base information cached yet, let's do that too
							localforage.getItem(cacheId()).then(function(info) {
								if (!info) {
									$.post("backend.php", {op: "getinfo", id: bookId }, function(data) {
										if (data) {
											localforage.setItem(cacheId(), data);

											if (data.has_cover) {
												fetch("backend.php?op=cover&id=" + bookId, {credentials: 'same-origin'}).then(function(resp) {
													if (resp.status == 200) {
														localforage.setItem(cacheId('cover'), resp.blob());
													}
												});
											}
										}
									});
								}
							});

							resp.blob().then(function(blob) {

								var fileReader = new FileReader();

								fileReader.onload = function() {
									book.open(this.result);
								};

								fileReader.readAsArrayBuffer(blob);

							});
						} else {
							$(".loading_message").html("Unable to download book: " + resp.status + ".");
						}
					});

				} else {
					$(".loading_message").html("This book is not available offline.");
				}
			}
		});

		localforage.getItem("epube.enable-fullscreen").then(function(enable) {
			_enable_fullscreen = enable;
		});

		EPUBJS.Hooks.register("beforeChapterDisplay").applyTheme = function(callback, renderer) {

			localforage.getItem("epube.theme").then(function(theme) {
				var base_url = window.location.href.match(/^.*\//)[0];

				if (!theme)
					theme = 'default';
				else
					theme = theme.replace("/", "");

				var theme_url = base_url + 'themes/' + theme + '.css';

				$(book.renderer.doc.head)
					.append($("<style type='text/css' id='theme_css'>")
					.text(_res_data[theme_url]));

				if (callback) callback();
			});
		}

		EPUBJS.Hooks.register("beforeChapterDisplay").initDict = function(callback, renderer) {

			var base_url = window.location.href.match(/^.*\//)[0];
			var res_names = [ "lib/bootstrap/v3/js/jquery.js", "lib/jquery.mobile.custom.js", "js/reader.js", "js/dict.js" ];
			var doc = book.renderer.doc;

			for (var i = 0; i < res_names.length; i++) {

				// we need to create script element with proper context, that is inside the iframe
				var elem = doc.createElement("script");
				elem.type = 'text/javascript';
				elem.text = _res_data[base_url + res_names[i]];

				doc.head.appendChild(elem);
			}

			$(book.renderer.doc.head)
				.append($("<style type='text/css'>")
				.text(_res_data[base_url + 'css/reader.css']));

			localforage.getItem("epube.disable-transitions").then(function(notransitions) {
				if (!notransitions) {
					$(book.renderer.doc.head)
						.append($("<style type='text/css'>")
						.text(_res_data[base_url + 'css/transitions.css']));

					EPUBJS.Render.Iframe.prototype.setLeft = function(leftPos){
			 			this.docEl.style[this.transform] = 'translate('+ (-leftPos) + 'px, 0)';
					}
				}
			});

        if (callback) callback();
		}

		if (_is_ios) {
			var book = ePub({
				restore: false,
				width: $("#reader").width(),
				height: $("#reader").height(),
			});
		} else {
			var book = ePub({
				restore: false,
				minSpreadWidth: 961,
			});
		}

		var fontSize;
		var fontFamily;
		var lineHeight;
		var themeName;

		Promise.all([
			localforage.getItem("epube.fontSize"),
			localforage.getItem("epube.fontFamily"),
			localforage.getItem("epube.lineHeight"),
			localforage.getItem("epube.theme")
		]).then(function(res) {
			fontSize = res[0] ? res[0] + "px" : DEFAULT_FONT_SIZE + "px";
			fontFamily = res[1] ? res[1] : DEFAULT_FONT_FAMILY;
			lineHeight = res[2] ? res[2] + "%" : DEFAULT_LINE_HEIGHT + "%";
			themeName = res[3] ? res[3] : 'default';

			book.setStyle("fontSize", fontSize);
			book.setStyle("fontFamily", fontFamily);
			book.setStyle("lineHeight", lineHeight);
			book.setStyle("textAlign", "justify");
		});

		window.book = book;
		var rendered = book.renderTo("reader");

		$('#settings-modal').on('shown.bs.modal', function() {

			$.post("backend.php", { op: "getlastread", id: $.urlParam("id") }, function(data) {
				$(".lastread_input").val(data.page);
			});

			localforage.getItem("epube.disable-transitions").then(function(disable) {
				$(".transition_checkbox")
					.attr("checked", disable)
					.on("click", function() {
						localforage.setItem("epube.disable-transitions", this.checked);
					});
			});

			localforage.getItem("epube.enable-fullscreen").then(function(enable) {
				$(".fullscreen_checkbox")
					.attr("checked", enable)
					.on("click", function() {
						localforage.setItem("epube.enable-fullscreen", this.checked);
					});
			});

			localforage.getItem("epube.fontFamily").then(function(font) {
				if (!font) font = DEFAULT_FONT_FAMILY;

				$(".font_family").val(font);
			});

			localforage.getItem("epube.theme").then(function(theme) {
				$(".theme_name").val(theme);
			});

			localforage.getItem("epube.fontSize").then(function(size) {

				if (!size) size = DEFAULT_FONT_SIZE;

				var zoom = $(".font_size").html("");

				for (var i = 10; i <= 32; i++) {
					var opt = $("<option>").val(i).html(i + " px");

					if (i == size) opt.attr("selected", "1");

					zoom.append(opt);
				}

			});

			localforage.getItem("epube.lineHeight").then(function(height) {

				if (!height) height = DEFAULT_LINE_HEIGHT;

				var zoom = $(".line_height").html("");

				for (var i = 100; i <= 220; i += 10) {
					var opt = $("<option>").val(i).html(i + "%");

					if (i == height) opt.attr("selected", "1");

					zoom.append(opt);
				}

			});
		})

		$('#dict-modal').on('shown.bs.modal', function() {
			$(".dict_result").scrollTop(0);

		})

		$(".dict_search_btn").on("click", function() {
			$("#dict-modal").modal('hide');
			window.open("https://google.com/search?q=" + $(".dict_query").val());
		});

		$('#toc-modal').on('shown.bs.modal', function() {
			function process_toc_sublist(row, list, nest) {

				if (nest == 3) return false;

				if (row.subitems) {

					var sublist = $("<ul class='toc_sublist list-unstyled'>");

					$.each(row.subitems, function(i, row) {

						var a = $("<a>")
							.attr('href', '#')
							.html(row.label + " <b class='pull-right'>" +
								book.pagination.pageFromCfi(row.cfi) + "</b>")
								.attr('data-cfi', row.cfi)
								.click(function() {
								book.gotoCfi(a.attr('data-cfi'));
							});

						sublist.append($("<li>").append(a));

						process_toc_sublist(row, sublist, nest + 1);

					});

					list.append(sublist);
				}
			}

			book.getToc().then(function(toc) {

				var list = $(".toc_list");
				list.html("");

				$.each(toc, function(i, row) {

					// if anything fails here the toc entry is likely useless anyway (i.e. no cfi)
					try {
						var a = $("<a>")
							.attr('href', '#')
							.html(row.label + " <b class='pull-right'>" +
								book.pagination.pageFromCfi(row.cfi) + "</b>")
								.attr('data-cfi', row.cfi)
								.click(function() {
								book.gotoCfi(a.attr('data-cfi'));
							});

						list.append($("<li>").append(a));

						process_toc_sublist(row, list, 0);

					} catch (e) {
						console.warn(e);
					}
				});

				// well the toc didn't work out, might as well generate one
				if (list.children().length <= 1) {

					list.html("");

					$.each(book.spine, function (i, row) {

						var a = $("<a>")
							.attr('href', '#')
							.attr('title', row.url)
							.html("Section " + (i+1) + " <b>(Loc. " +
								book.pagination.pageFromCfi(row.cfi) + ")</b>")
							.attr('data-cfi', row.cfi)
							.click(function() {
								book.gotoCfi(a.attr('data-cfi'));
							});

						list.append($("<li>").append(a));

					});
				}

			});
		})

		book.on("renderer:chapterUnloaded", function() {
			$(".loading").show();
			$(".loading_message").html("Opening chapter...");
		});

		book.on("renderer:resized", function() {
			$(".loading").show();
			$(".loading_message").html("Opening chapter...");

			window.setTimeout(function() {
				open_lastread();

				window.setTimeout(function() {
					$(".loading").hide();
				}, 500);
			}, 500);
		});

		book.on("renderer:chapterDisplayed", function() {
			$(".chapter").html("");

			localforage.getItem("epube.disable-transitions").then(function(notransitions) {
				if (notransitions) {
					$(".loading").hide();
				} else {
					window.setTimeout(function() {
						$(".loading").hide();
					}, 500);
				}
			} );

			var toc_entry = false;

			function iterate_sublist(row, nest) {
				if (nest == 3) return false;

				if (row.subitems) {
					$.each(row.subitems, function (i, r) {

						if (r.spinePos == book.currentChapter.spinePos) {
							toc_entry = r;
							return true;
						}

						if (iterate_sublist(r, nest + 1))
							return true;
					});
				}

				return false;
			}

			$.each(book.toc, function(i, a) {
				if (a.spinePos == book.currentChapter.spinePos) {
					toc_entry = a;
					return;
				}

				if (iterate_sublist(a, 0)) return;

			});

			console.log('toc', toc_entry);

			if (toc_entry) $(".chapter").html(toc_entry.label);
		});

		book.on("renderer:chapterDisplayed", function() {
			$("#reader iframe")[0].contentWindow.onwheel = function(event) {

				if (event.deltaY > 0) {
					next_page();
				} else if (event.deltaY < 0) {
					prev_page();
				}

			};
		});

		/* book.on("renderer:chapterDisplayed", function() {

			// variables defined above after reading from localforage

			$("#reader iframe").contents().find("p")
				.css("background", "")
				.css("color", "")
				.css("background-color", "")
				.css("font-family", fontFamily)
				.css("font-size", fontSize)
				.css("line-height", lineHeight)
				.css("text-align", "justify");

		}); */

		book.on("renderer:keydown", hotkey_handler);

		book.getMetadata().then(function(meta){
			document.title = meta.bookTitle + " – " + meta.creator;
			$(".title").html("<b>" + meta.bookTitle + "</b> - " + meta.creator);
		});

		rendered.then(function() {

			localforage.getItem(cacheId("pagination")).then(function(pageList) {

				if (pageList && book.loadPagination(pageList).length > 0) {
					_pagination_stored = 1;
				} else {
					var url = "backend.php?op=getpagination&id=" + encodeURIComponent($.urlParam("id"));

					EPUBJS.core.request(url).then(function(pageList) {
						console.log("pagination: requesting remote: ");

						if (book.loadPagination(pageList).length > 0) {
							localforage.setItem(cacheId("pagination"), JSON.parse(pageList));
							_pagination_stored = 1;
						} else {
							book.generatePagination(1020, 2400);
						}

					}).catch(function() {
						book.generatePagination(1020, 2400);
					});
				}
			});

		});

		book.pageListReady.then(function(pageList) {
			if (!_pagination_stored) {
				if (navigator.onLine) {
					$.post("backend.php", { op: "storepagination", id: $.urlParam("id"),
						payload: JSON.stringify(pageList), total: book.pagination.totalPages });
				}

				localforage.setItem(cacheId("pagination"), pageList);
			}

			var curPage = book.pagination.pageFromCfi(book.getCurrentLocationCfi());

			$("#total_pages").html(book.pagination.totalPages);
			$("#cur_page").html(curPage);

			if (book.pagination.totalPages > 0) {
				var pct = parseInt(curPage / book.pagination.totalPages * 100);
				$("#page_pct").html(pct + "%");
			}

			open_lastread();

			window.setTimeout(function() {
				$(".loading").hide();
			}, 1500);

			$(".location").click(function() {
				var current = book.pagination.pageFromCfi(book.getCurrentLocationCfi());
				var total = book.pagination.totalPages;

				var page = prompt("Jump to location [1-" + total + "]", current);

				if (page) {
					book.gotoPage(page);
				}

			});

		});

		book.on('book:pageChanged', function(location) {

			$("#cur_page").html(location.anchorPage);

			var total = book.pagination.totalPages;

			if (book.pagination.totalPages > 0) {
				var pct = parseInt(location.anchorPage / book.pagination.totalPages * 100);
				$("#page_pct").html(pct + "%");
			}

			if (_store_position && new Date().getTime()/1000 - _last_position_sync > 15) {
				console.log("storing lastread");

				var currentCfi = book.getCurrentLocationCfi();
				var currentPage = location.anchorPage;
				var totalPages = book.pagination.totalPages;

				if (navigator.onLine) {

					$.post("backend.php", { op: "storelastread", id: $.urlParam("id"), page: currentPage,
						cfi: currentCfi }, function(data) {

						if (data.cfi) {
							_last_position_sync = new Date().getTime()/1000;
						}

					});

					_store_position = 0;

				} else {
					_last_position_sync = 0;
				}

				localforage.setItem(cacheId("lastread"),
					{cfi: currentCfi, page: currentPage, total: totalPages});

			}
		});

	}
</script>

</body>
</html>
